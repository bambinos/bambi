
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Hierarchical Linear Regression (Radon Contamination dataset) &#8212; Bambi 0.9.1 documentation</title>
  <script>
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=9b1a4fa89bdd0e95b23b" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=9b1a4fa89bdd0e95b23b" rel="stylesheet">

  
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/6.1.2/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=9b1a4fa89bdd0e95b23b">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/radon_example';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Bayesian Workflow (Strack RRR Analysis Replication)" href="Strack_RRR_re_analysis.html" />
    <link rel="prev" title="Hierarchical Linear Regression (Sleepstudy example)" href="sleepstudy.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs..." aria-label="Search the docs..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fas fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../index.html">

  
  
  
  
  
  
  

  
    <img src="../_static/Bambi_logo.png" class="logo__image only-light" alt="Logo image">
    <img src="../_static/Bambi_logo.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                <li class="nav-item">
                    <a class="nav-link" href="getting_started.html">
                        Getting Started
                    </a>
                </li>
                

                <li class="nav-item current active">
                    <a class="nav-link" href="../examples.html">
                        Examples
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../api_reference.html">
                        API Reference
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../faq.html">
                        Frequently Asked Questions
                    </a>
                </li>
                
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      <div class="navbar-end-item navbar-end__search-button-container">
        
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search">
  <i class="fas fa-search"></i>
</button>
      </div>
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          <a href="https://github.com/bambinos/bambi" title="GitHub" class="nav-link" rel="noopener" target="_blank"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          <a href="https://pypi.org/project/bambi/" title="PyPi" class="nav-link" rel="noopener" target="_blank"><span><i class="fas fa-box"></i></span>
            <label class="sr-only">PyPi</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>


  
  <div class="search-button-container--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search">
  <i class="fas fa-search"></i>
</button>
  </div>

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fas fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                <li class="nav-item">
                    <a class="nav-link" href="getting_started.html">
                        Getting Started
                    </a>
                </li>
                

                <li class="nav-item current active">
                    <a class="nav-link" href="../examples.html">
                        Examples
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../api_reference.html">
                        API Reference
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../faq.html">
                        Frequently Asked Questions
                    </a>
                </li>
                
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          <a href="https://github.com/bambinos/bambi" title="GitHub" class="nav-link" rel="noopener" target="_blank"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          <a href="https://pypi.org/project/bambi/" title="PyPi" class="nav-link" rel="noopener" target="_blank"><span><i class="fas fa-box"></i></span>
            <label class="sr-only">PyPi</label></a>
        </li>
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
    </div>
    <div class="sidebar-start-items__item">

  

  

<nav class="bd-links" id="bd-docs-nav" aria-label="Versions navigation">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
        <li class="toctree-l1 has-children">
            <p class="caption"><span class="caption-text">Version</span></p>
            <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox">
            <label for="toctree-checkbox-1"> <i class="fas fa-chevron-down"></i></label>

            <ul>
                  
                  <li><a href="../../main/index.html"> Development </a></li>
                  

                

                  
                    <li class="toctree-l2 current active"><a href="radon_example.html">0.9.1 (latest)</a></li>
                  

                

                

                  
                    <li><a href="../../0.9.0/index.html">0.9.0</a></li>
                  

                

                

                  
                    <li><a href="../../0.8.0/index.html">0.8.0</a></li>
                  

                

                

                  
                    <li><a href="../../0.7.1/index.html">0.7.1</a></li>
                  

                

                

                  
                    <li><a href="../../0.7.0/index.html">0.7.0</a></li>
                  

                

                

                  
                    <li><a href="../../0.6.3/index.html">0.6.3</a></li>
                  

                

                

                  
                    <li><a href="../../0.6.2/index.html">0.6.2</a></li>
                  

                

                

                  
                    <li><a href="../../0.6.1/index.html">0.6.1</a></li>
                  

                

                

                  
                    <li><a href="../../0.6.0/index.html">0.6.0</a></li>
                  

                

                

                  
                    <li><a href="../../0.5.0/index.html">0.5.0</a></li>
                  

                

                

                  
                    <li><a href="../../0.4.1/index.html">0.4.1</a></li>
                  

                

                

                  
                    <li><a href="../../0.4.0/index.html">0.4.0</a></li>
                  

                

                

                  
                    <li><a href="../../0.3.0/index.html">0.3.0</a></li>
                  

                

                

                  
                    <li><a href="../../0.2.0/index.html">0.2.0</a></li>
                  

                

                

                  
                    <li><a href="../../0.1.5/index.html">0.1.5</a></li>
                  

                

            </ul>
        </li>
        </ul>
    </div>
  </nav>


    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

      </div>
      <main class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Hierarchical-Linear-Regression-(Radon-Contamination-dataset)">
<h1>Hierarchical Linear Regression (Radon Contamination dataset)<a class="headerlink" href="#Hierarchical-Linear-Regression-(Radon-Contamination-dataset)" title="Permalink to this heading">#</a></h1>
<p>In this notebook we want to revisit the classical hierarchical linear regression model based on the dataset of the <em>Radon Contamination</em> by Gelman and Hill. In particular, we want to show how easy is to port the <a class="reference external" href="https://docs.pymc.io/en/v3/">PyMC</a> models, presented in the very complete article <a class="reference external" href="https://docs.pymc.io/projects/examples/en/latest/case_studies/multilevel_modeling.html">A Primer on Bayesian Methods for Multilevel Modeling</a>, to
<a class="reference external" href="https://bambinos.github.io/bambi/main/index.html">Bambi</a> using the more concise formula specification for the models.</p>
<p>This example has been ported from PyMC by Juan Orduz (<a class="reference external" href="https://github.com/juanitorduz">&#64;juanitorduz</a>) and Bambi developers.</p>
<section id="Prepare-Notebook">
<h2>Prepare Notebook<a class="headerlink" href="#Prepare-Notebook" title="Permalink to this heading">#</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">bambi</span> <span class="k">as</span> <span class="nn">bmb</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pymc</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;arviz-darkgrid&quot;</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">8924</span><span class="p">)</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>
</div>
</div>
</section>
<section id="Read-Data">
<h2>Read Data<a class="headerlink" href="#Read-Data" title="Permalink to this heading">#</a></h2>
<p>Let us load the data into a pandas data frame.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get radon data</span>
<span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/pymc-devs/pymc-examples/main/examples/data/srrs2.dat&quot;</span>
<span class="n">radon_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="c1"># Get city data</span>
<span class="n">city_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;cty.dat&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">radon_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">radon_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>idnum</th>
      <th>state</th>
      <th>state2</th>
      <th>stfips</th>
      <th>zip</th>
      <th>region</th>
      <th>typebldg</th>
      <th>floor</th>
      <th>room</th>
      <th>basement</th>
      <th>...</th>
      <th>stoptm</th>
      <th>startdt</th>
      <th>stopdt</th>
      <th>activity</th>
      <th>pcterr</th>
      <th>adjwt</th>
      <th>dupflag</th>
      <th>zipflag</th>
      <th>cntyfips</th>
      <th>county</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>AZ</td>
      <td>AZ</td>
      <td>4</td>
      <td>85920</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>N</td>
      <td>...</td>
      <td>1100</td>
      <td>112987</td>
      <td>120287</td>
      <td>0.3</td>
      <td>0.0</td>
      <td>136.060971</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>APACHE</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>AZ</td>
      <td>AZ</td>
      <td>4</td>
      <td>85920</td>
      <td>1</td>
      <td>0</td>
      <td>9</td>
      <td>0</td>
      <td></td>
      <td>...</td>
      <td>700</td>
      <td>70788</td>
      <td>71188</td>
      <td>0.6</td>
      <td>33.3</td>
      <td>128.784975</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>APACHE</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>AZ</td>
      <td>AZ</td>
      <td>4</td>
      <td>85924</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>N</td>
      <td>...</td>
      <td>1145</td>
      <td>70788</td>
      <td>70788</td>
      <td>0.5</td>
      <td>0.0</td>
      <td>150.245112</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>APACHE</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>AZ</td>
      <td>AZ</td>
      <td>4</td>
      <td>85925</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>N</td>
      <td>...</td>
      <td>1900</td>
      <td>52088</td>
      <td>52288</td>
      <td>0.6</td>
      <td>97.2</td>
      <td>136.060971</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>APACHE</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>AZ</td>
      <td>AZ</td>
      <td>4</td>
      <td>85932</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>N</td>
      <td>...</td>
      <td>900</td>
      <td>70788</td>
      <td>70788</td>
      <td>0.3</td>
      <td>0.0</td>
      <td>136.060971</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>APACHE</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 25 columns</p>
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
12777
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">city_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">city_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>stfips</th>
      <th>ctfips</th>
      <th>st</th>
      <th>cty</th>
      <th>lon</th>
      <th>lat</th>
      <th>Uppm</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>AL</td>
      <td>AUTAUGA</td>
      <td>-86.643</td>
      <td>32.534</td>
      <td>1.78331</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>3</td>
      <td>AL</td>
      <td>BALDWIN</td>
      <td>-87.750</td>
      <td>30.661</td>
      <td>1.38323</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>5</td>
      <td>AL</td>
      <td>BARBOUR</td>
      <td>-85.393</td>
      <td>31.870</td>
      <td>2.10105</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>7</td>
      <td>AL</td>
      <td>BIBB</td>
      <td>-87.126</td>
      <td>32.998</td>
      <td>1.67313</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>9</td>
      <td>AL</td>
      <td>BLOUNT</td>
      <td>-86.568</td>
      <td>33.981</td>
      <td>1.88501</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
3194
</pre></div></div>
</div>
</section>
<section id="Preprocess-Data">
<h2>Preprocess Data<a class="headerlink" href="#Preprocess-Data" title="Permalink to this heading">#</a></h2>
<p>We are going to preprocess the data as done in the article <a class="reference external" href="https://docs.pymc.io/projects/examples/en/latest/case_studies/multilevel_modeling.html">A Primer on Bayesian Methods for Multilevel Modeling</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Strip spaces from column names</span>
<span class="n">radon_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">radon_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">)</span>

<span class="c1"># Filter to keep observations for &quot;MN&quot; state only</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">radon_df</span><span class="p">[</span><span class="n">radon_df</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;MN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">city_mn_df</span> <span class="o">=</span> <span class="n">city_df</span><span class="p">[</span><span class="n">city_df</span><span class="o">.</span><span class="n">st</span> <span class="o">==</span> <span class="s2">&quot;MN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Compute fips</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;fips&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1_000</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">stfips</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">cntyfips</span>
<span class="n">city_mn_df</span><span class="p">[</span><span class="s2">&quot;fips&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1_000</span> <span class="o">*</span> <span class="n">city_mn_df</span><span class="o">.</span><span class="n">stfips</span> <span class="o">+</span> <span class="n">city_mn_df</span><span class="o">.</span><span class="n">ctfips</span>

<span class="c1"># Merge data</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">city_mn_df</span><span class="p">[[</span><span class="s2">&quot;fips&quot;</span><span class="p">,</span> <span class="s2">&quot;Uppm&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;fips&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;idnum&quot;</span><span class="p">)</span>

<span class="c1"># Clean county names</span>
<span class="n">df</span><span class="o">.</span><span class="n">county</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">county</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">)</span>

<span class="c1"># Compute log(radon + 0.1)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;log_radon&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;activity&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Compute log of Uranium</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;log_u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Uppm&quot;</span><span class="p">])</span>

<span class="c1"># Let&#39;s map floor. 0 -&gt; Basement and 1 -&gt; Floor</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;floor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;floor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;Basement&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;Floor&quot;</span><span class="p">})</span>

<span class="c1"># Sort values by floor</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;floor&quot;</span><span class="p">)</span>

<span class="c1"># Reset index</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>In this exercise, we model the logarithm of the Radon measurements. This is because the distribution of the Radon level is approximately log-normal. We also add a small number, 0.1, to prevent us from trying to compute the logarithm of 0.</p>
</section>
<section id="EDA">
<h2>EDA<a class="headerlink" href="#EDA" title="Permalink to this heading">#</a></h2>
<p>In order to get a glimpse of the data, we are going to do some exploratory data analysis. First, let’s have a look at the global distribution of the untransformed radon levels.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;activity&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="n">common_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;activity&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Density of Radon&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Radon&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Density&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_12_0.png" src="../_images/notebooks_radon_example_12_0.png" />
</div>
</div>
<p>Next, let us see the global <code class="docutils literal notranslate"><span class="pre">log(radon</span> <span class="pre">+</span> <span class="pre">0.1)</span></code> distribution.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;log_radon&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="n">common_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;log_radon&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Density of log(Radon + 0.1)&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;$\log(Radon + 0.1)$&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Density&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_14_0.png" src="../_images/notebooks_radon_example_14_0.png" />
</div>
</div>
<p>There are many a priori reasons to think houses with basement has higher radon levels. From geochemistry to composition of building materials to poor ventilation. We can split the distribution of <code class="docutils literal notranslate"><span class="pre">log(radon</span> <span class="pre">+</span> <span class="pre">0.1)</span></code> per <code class="docutils literal notranslate"><span class="pre">floor</span></code> to see if we are able to see that difference in our data.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;log_radon&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;floor&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
    <span class="n">common_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
<span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;log_radon&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;floor&quot;</span><span class="p">,</span> <span class="n">common_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Density of log(Radon + 0.1)&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;$\log + 0.1$&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Density&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_16_0.png" src="../_images/notebooks_radon_example_16_0.png" />
</div>
</div>
<p>This exploration tell us that, as expected, the average radon level is higher in <code class="docutils literal notranslate"><span class="pre">Basement</span></code> than <code class="docutils literal notranslate"><span class="pre">Floor</span></code>.</p>
<p>Next, we are going to count the number of counties.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_counties</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;county&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">size</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of counties: </span><span class="si">{</span><span class="n">n_counties</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of counties: 85
</pre></div></div>
</div>
<p>Let us dig deeper into the distribution of radon and number of observations per county and floor level.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">log_radon_county_agg</span>  <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;county&quot;</span><span class="p">,</span> <span class="s2">&quot;floor&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
        <span class="n">log_radon_mean</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;log_radon&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">),</span>
        <span class="n">n_obs</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;log_radon&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;constrained&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;floor&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;log_radon_mean&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">log_radon_county_agg</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;log(Radon + 0.1) Mean per County&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;$\log + 0.1$&quot;</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;floor&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;n_obs&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">log_radon_county_agg</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Number of Observations&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;floor&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Number of observations&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_21_0.png" src="../_images/notebooks_radon_example_21_0.png" />
</div>
</div>
<ul class="simple">
<li><p>On the left hand side we can see that the <code class="docutils literal notranslate"><span class="pre">&quot;Basement&quot;</span></code> distribution per county is shifted to higher values with respect to the <code class="docutils literal notranslate"><span class="pre">&quot;Floor&quot;</span></code> distribution. We had seen this above when considering all counties together.</p></li>
<li><p>On the right hand side we see that the number of observations per county is not the same for the <code class="docutils literal notranslate"><span class="pre">floor</span></code> levels. In particular, we see that there are some counties with a lot of basement observations. This can create some bias when computing simple statistics to compare across counties. Moreover, not all <code class="docutils literal notranslate"><span class="pre">county</span></code> and <code class="docutils literal notranslate"><span class="pre">floor</span></code> combinations are present in the dataset. For example:</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;county == &#39;YELLOW MEDICINE&#39; and floor == &#39;Floor&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">empty</span>
</pre></div>
</div>
</div>
</section>
<section id="Models:-Conventional-Approaches">
<h2>Models: Conventional Approaches<a class="headerlink" href="#Models:-Conventional-Approaches" title="Permalink to this heading">#</a></h2>
<section id="Complete-Pooling">
<h3>Complete Pooling<a class="headerlink" href="#Complete-Pooling" title="Permalink to this heading">#</a></h3>
<section id="Model">
<h4>Model<a class="headerlink" href="#Model" title="Permalink to this heading">#</a></h4>
<p>For this first model we only consider the predictor <code class="docutils literal notranslate"><span class="pre">floor</span></code>, which represents the floor level. The following equation describes the linear model that we are going to build with Bambi</p>
<div class="math notranslate nohighlight">
\[y = \beta_{j} + \varepsilon\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
y &amp;= \text{Response for the (log) radon measurement }\\
\beta_{j} &amp;= \text{Coefficient for the floor level } j \\
\varepsilon &amp; = \text{Residual random error}
\end{aligned}\end{split}\]</div>
<p>Each <span class="math notranslate nohighlight">\(j\)</span> indexes a different floor level. In this case, <span class="math notranslate nohighlight">\(j=1\)</span> means <code class="docutils literal notranslate"><span class="pre">&quot;basement&quot;</span></code> and <span class="math notranslate nohighlight">\(j=2\)</span> means <code class="docutils literal notranslate"><span class="pre">&quot;floor&quot;</span></code>.</p>
</section>
<section id="Priors">
<h4>Priors<a class="headerlink" href="#Priors" title="Permalink to this heading">#</a></h4>
<section id="Common-effects">
<h5>Common effects<a class="headerlink" href="#Common-effects" title="Permalink to this heading">#</a></h5>
<p>The only common effect in this model is the floor effect represented by the <span class="math notranslate nohighlight">\(\beta_{j}\)</span> coefficients. We have</p>
<div class="math notranslate nohighlight">
\[\beta_{j} \sim \text{Normal}(0, \sigma_{\beta_j})\]</div>
<p>for <span class="math notranslate nohighlight">\(j: 1, 2\)</span>, where <span class="math notranslate nohighlight">\(\sigma_{\beta_j}\)</span> is a positive constant that we set to 10 for all <span class="math notranslate nohighlight">\(j\)</span>.</p>
</section>
<section id="Residual-error">
<h5>Residual error<a class="headerlink" href="#Residual-error" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\varepsilon &amp; \sim \text{Normal}(0, \sigma) \\
\sigma &amp; \sim \text{Exponential}(\lambda)
\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda\)</span> is a positive constant that we set to 1.</p>
<p>Let us now write the Bambi model.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">0</span></code> on the right side of <code class="docutils literal notranslate"><span class="pre">~</span></code> in the model formula removes the global intercept that is added by default. This allows Bambi to use one coefficient for each floor level.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># A dictionary with the priors we pass to the model initialization</span>
<span class="n">pooled_priors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;floor&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Exponential&quot;</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">pooled_model</span> <span class="o">=</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="s2">&quot;log_radon ~ 0 + floor&quot;</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="n">pooled_priors</span><span class="p">)</span>
<span class="n">pooled_model</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Formula: log_radon ~ 0 + floor
Family name: Gaussian
Link: identity
Observations: 919
Priors:
  Common-level effects
    floor ~ Normal(mu: 0, sigma: 10)

  Auxiliary parameters
    sigma ~ Exponential(lam: 1)
</pre></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Family</span> <span class="pre">name:</span> <span class="pre">Gaussian</span></code> indicates the selected family, which defaults to Gaussian. And <code class="docutils literal notranslate"><span class="pre">Link:</span> <span class="pre">identity</span></code> indicates the default value for the link argument in <code class="docutils literal notranslate"><span class="pre">bmb.Model()</span></code>. Taken together this simply means that we are fitting a normal linear regression model.</p>
<p>Let’s see the graph representation of the model before fitting. To do so, we first need to call the <code class="docutils literal notranslate"><span class="pre">.build()</span></code> method. Internally, this builds the underlying PyMC model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pooled_model</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="n">pooled_model</span><span class="o">.</span><span class="n">graph</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_32_0.svg" src="../_images/notebooks_radon_example_32_0.svg" /></div>
</div>
<p>Let’s now fit the model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pooled_results</span> <span class="o">=</span> <span class="n">pooled_model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [floor, log_radon_sigma]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
  <progress value='8000' class='' max='8000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [8000/8000 00:07<00:00 Sampling 4 chains, 0 divergences]
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 8 seconds.
</pre></div></div>
</div>
<p>Now we can examine the posterior distribution, i.e. the joint distribution of model parameters conditional on the data:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pooled_results</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chain_prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Pooled Model Trace&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_36_0.png" src="../_images/notebooks_radon_example_36_0.png" />
</div>
</div>
<p>We can also see some posterior summary statistics.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pooled_summary</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pooled_results</span><span class="p">)</span>
<span class="n">pooled_summary</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>floor[Basement]</th>
      <td>1.363</td>
      <td>0.028</td>
      <td>1.311</td>
      <td>1.416</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>5441.0</td>
      <td>2814.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>floor[Floor]</th>
      <td>0.775</td>
      <td>0.066</td>
      <td>0.655</td>
      <td>0.898</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>5381.0</td>
      <td>2969.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>log_radon_sigma</th>
      <td>0.791</td>
      <td>0.019</td>
      <td>0.756</td>
      <td>0.826</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>5126.0</td>
      <td>2817.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>From the posterior plot and the summary, we can see the mean radon level is considerably higher in the Basement than in the Floor level. This reflects what we originally saw in the initial data exploration. In addition, sice we have more measurements in the Basement, the uncertainty in its posterior is smaller than the uncertainty in the posterior for the Floor level.</p>
<p>We can compare the mean of the posterior distribution of the <code class="docutils literal notranslate"><span class="pre">floor</span></code> terms to the sample mean. This is going to be useful to understand the meaning of <strong>complete pooling</strong>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="p">(</span>
    <span class="n">pooled_summary</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">floor</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">right</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;floor&quot;</span><span class="p">])[</span><span class="s2">&quot;log_radon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;floor&quot;</span><span class="p">,</span>
        <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="s2">&quot;posterior mean&quot;</span><span class="p">,</span>
        <span class="s2">&quot;log_radon&quot;</span><span class="p">:</span> <span class="s2">&quot;sample mean&quot;</span>
    <span class="p">})</span>
    <span class="o">.</span><span class="n">melt</span><span class="p">(</span>
        <span class="n">id_vars</span><span class="o">=</span><span class="s2">&quot;floor&quot;</span><span class="p">,</span>
        <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;posterior mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sample mean&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">((</span><span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">),</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;floor&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;variable&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;log(Radon + 0.1) Mean per Floor - Pooled Model&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;$\log + 0.1$&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_41_0.png" src="../_images/notebooks_radon_example_41_0.png" />
</div>
</div>
<p>From the plot alone it is hard to detect the difference between the posterior mean and the sample mean. This happens because the estimation for any observation in either group is simply the group mean plus the smoothing due to the non-flat priors.</p>
<p>In other words, for every observation where <code class="docutils literal notranslate"><span class="pre">floor</span></code> is <code class="docutils literal notranslate"><span class="pre">&quot;Basement&quot;</span></code> the model predicts the mean radon for all the basement measurements, and for every observation where <code class="docutils literal notranslate"><span class="pre">floor</span></code> is <code class="docutils literal notranslate"><span class="pre">&quot;Floor&quot;</span></code>, the model predicts the mean radon for all the floor measurements.</p>
<p><strong>What does complete pooling exactly mean here?</strong></p>
<p>In this example, the pooling refers to how we treat the different counties when computing estimates (i.e. this does not refer to pooling across floor levels for example). <em>Complete pooling</em> means that all measurements for all counties are pooled into a single estimate (“treat all counties the same”), conditional on the floor level (because it is used as a covariate/predictor). For that reason, when computing the prediction for a given observation, we do not discriminate which county it belongs
to. We pool all the counties into a single estimate, or in other words, we perform a complete pooling.</p>
<p>Let’s now compare the posterior predictive distribution for each group with the distribution of the observed data.</p>
<p>To do this we need to perform a couple of steps:</p>
<ul class="simple">
<li><p>Obtain samples from the posterior predictive distribution using the <code class="docutils literal notranslate"><span class="pre">.predict()</span></code> method.</p></li>
<li><p>Apply the inverse transform to have the posterior predictive samples in the original scale of the response.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note we create a new data set.</span>
<span class="c1"># One observation per group is enough to obtain posterior predictive samples for that group</span>
<span class="c1"># The more observations we create, the more posterior predictive samples from the same distribution</span>
<span class="c1"># we obtain.</span>
<span class="n">new_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;floor&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Basement&quot;</span><span class="p">,</span> <span class="s2">&quot;Floor&quot;</span><span class="p">]})</span>
<span class="n">pooled_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pooled_results</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;pps&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">new_data</span><span class="p">)</span>

<span class="c1"># Stack chains and draws and extract posterior predictive samples</span>
<span class="n">pps</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract_dataset</span><span class="p">(</span><span class="n">pooled_results</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;posterior_predictive&quot;</span><span class="p">)[</span><span class="s2">&quot;log_radon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Inverse transform the posterior predictive samples</span>
<span class="n">pps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pps</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;constrained&quot;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">pps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Basement (Posterior Predictive Distribution)&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;radon&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;activity&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;floor == &#39;Basement&#39;&quot;</span><span class="p">),</span> <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Basement (Sample Distribution)&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;radon&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">pps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Floor (Posterior Predictive Distribution)&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;radon&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;activity&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;floor == &#39;Floor&#39;&quot;</span><span class="p">),</span> <span class="n">stat</span><span class="o">=</span><span class="s2">&quot;density&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Floor (Sample Distribution)&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;radon&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Density&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_44_0.png" src="../_images/notebooks_radon_example_44_0.png" />
</div>
</div>
<p>The distributions look very similar, but we see that we have some extreme values. Hence if we need a number to compare them let us use the median.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">pps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([3.73843077, 2.08995068])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;floor&quot;</span><span class="p">])[</span><span class="s2">&quot;activity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
floor
Basement    3.9
Floor       2.1
Name: activity, dtype: float64
</pre></div></div>
</div>
</section>
</section>
</section>
<section id="No-Pooling">
<h3>No Pooling<a class="headerlink" href="#No-Pooling" title="Permalink to this heading">#</a></h3>
<p>The following model uses both <code class="docutils literal notranslate"><span class="pre">floor</span></code> and <code class="docutils literal notranslate"><span class="pre">county</span></code> as predictors. They are represented with an interaction effect. It means the predicted radon level for a given measurement depends both on the floor level as well as the county. This interaction coefficient allows the floor effect to vary across counties. Or said analogously, the county effect can vary across floor levels.</p>
<section id="id1">
<h4>Model<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h4>
<div class="math notranslate nohighlight">
\[y = \gamma_{jk} + \varepsilon\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
y &amp;= \text{Response for the (log) radon measurement }\\
\gamma_{jk} &amp;= \text{Coefficient for floor level } j \text{ and county } k\\
\varepsilon &amp; = \text{Residual random error}
\end{aligned}\end{split}\]</div>
</section>
<section id="id2">
<h4>Priors<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h4>
<section id="id3">
<h5>Common effects<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h5>
<p>The common effect is the interaction between <code class="docutils literal notranslate"><span class="pre">floor</span></code> and <code class="docutils literal notranslate"><span class="pre">county</span></code>. The prior is</p>
<div class="math notranslate nohighlight">
\[\gamma_{jk} \sim \text{Normal}(0, \sigma_{\gamma_{jk}})\]</div>
<div class="line-block">
<div class="line">for all <span class="math notranslate nohighlight">\(j: 1, 2\)</span> and <span class="math notranslate nohighlight">\(k: 1, \cdots, 85\)</span>.</div>
<div class="line"><span class="math notranslate nohighlight">\(\sigma_{\gamma_{jk}}\)</span> is a positive constant that we set to 10 in all cases.</div>
</div>
</section>
<section id="id4">
<h5>Residual error<a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\varepsilon_i &amp; \sim \text{Normal}(0, \sigma) \\
\sigma &amp; \sim \text{Exponential}(\lambda)
\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda\)</span> is a positive constant that we set to 1.</p>
<p>To specify this model in Bambi we can use the formula <code class="docutils literal notranslate"><span class="pre">log_radon</span> <span class="pre">~</span> <span class="pre">0</span> <span class="pre">+</span> <span class="pre">county:floor</span></code>. Again, we remove the global intercept with the <code class="docutils literal notranslate"><span class="pre">0</span></code> on the right hand side. <code class="docutils literal notranslate"><span class="pre">county:floor</span></code> specifies the multiplicative interaction between <code class="docutils literal notranslate"><span class="pre">county</span></code> and <code class="docutils literal notranslate"><span class="pre">floor</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unpooled_priors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;county:floor&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Exponential&quot;</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">unpooled_model</span> <span class="o">=</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="s2">&quot;log_radon ~ 0 + county:floor&quot;</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="n">unpooled_priors</span><span class="p">)</span>
<span class="n">unpooled_model</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Formula: log_radon ~ 0 + county:floor
Family name: Gaussian
Link: identity
Observations: 919
Priors:
  Common-level effects
    county:floor ~ Normal(mu: 0, sigma: 10)

  Auxiliary parameters
    sigma ~ Exponential(lam: 1)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unpooled_results</span> <span class="o">=</span> <span class="n">unpooled_model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [county:floor, log_radon_sigma]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
  <progress value='8000' class='' max='8000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [8000/8000 01:12<00:00 Sampling 4 chains, 0 divergences]
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 73 seconds.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unpooled_model</span><span class="o">.</span><span class="n">graph</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_54_0.svg" src="../_images/notebooks_radon_example_54_0.svg" /></div>
</div>
<p>From the graph representation of the model we see the model estimates <span class="math notranslate nohighlight">\(170 = 85 \times 2\)</span> parameters for the <code class="docutils literal notranslate"><span class="pre">county:floor</span></code> interaction. Let us now explore the model fit.</p>
<p>First, we can now see the plot of the marginal posterior distributions along with the sampling traces.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">unpooled_results</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chain_prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Un-Pooled Model Trace&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_57_0.png" src="../_images/notebooks_radon_example_57_0.png" />
</div>
</div>
<p>Some posteriors for <code class="docutils literal notranslate"><span class="pre">county:floor</span></code> are much more spread than others, which makes it harder to compare them. To obtain a better summary visualization we can use a forest plot. This plot also allows us to identify exactly the combination of <code class="docutils literal notranslate"><span class="pre">county</span></code> and <code class="docutils literal notranslate"><span class="pre">floor</span></code> level.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">unpooled_results</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">r_hat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">textsize</span><span class="o">=</span><span class="mi">8</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_59_0.png" src="../_images/notebooks_radon_example_59_0.png" />
</div>
</div>
<p>Note how for the combination <code class="docutils literal notranslate"><span class="pre">county</span> <span class="pre">==</span> <span class="pre">'YELLOW</span> <span class="pre">MEDICINE'</span> <span class="pre">and</span> <span class="pre">floor</span> <span class="pre">==</span> <span class="pre">'Floor'</span></code> where we do not have any observations, the model can still generate predictions which are essentially coming from the prior distributions, which explains the large HDI intervals.</p>
<p>Next, let’s have a look into the posterior mean for each <code class="docutils literal notranslate"><span class="pre">county</span></code> and <code class="docutils literal notranslate"><span class="pre">floor</span></code> combination:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unpooled_summary</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">unpooled_results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can now plot the posterior distribution mean of the gamma coefficients against the observed values (sample).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get county and floor names from summary table</span>
<span class="n">var_mapping</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">unpooled_summary</span>
    <span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">var_mapping</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;county&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;floor&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">var_mapping</span><span class="p">[</span><span class="s2">&quot;county&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_mapping</span><span class="p">[</span><span class="s2">&quot;county&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">var_mapping</span><span class="p">[</span><span class="s2">&quot;floor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_mapping</span><span class="p">[</span><span class="s2">&quot;floor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">var_mapping</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">unpooled_summary</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

<span class="c1"># Merge with observed values</span>
<span class="n">unpooled_summary_2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">var_mapping</span><span class="p">,</span> <span class="n">unpooled_summary</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="p">(</span>
    <span class="n">unpooled_summary_2</span>
    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">log_radon_county_agg</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;county&quot;</span><span class="p">,</span> <span class="s2">&quot;floor&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
        <span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">),</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;log_radon_mean&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;floor&quot;</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axline</span><span class="p">(</span><span class="n">xy1</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">slope</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;diagonal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;log(Radon + 0.1) Mean per County (Unpooled Model)&quot;</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;observed (sample)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_64_0.png" src="../_images/notebooks_radon_example_64_0.png" />
</div>
</div>
<p>As expected, the values strongly concentrated along the diagonal. In other words, for each county and floor level combination, the model uses their sample mean of radon level as prediction, plus smoothing due to the non-flat priors.</p>
<p><strong>What does no pooling exactly mean here?</strong></p>
<p>In the previous example we said <em>complete pooling</em> means the observations are pooled together into single estimates no matter the county they belong to. The situation is completely the opposite in this <em>no pooling</em> scenario. Here, none of the measurements in a given county affect the computation of the coefficient for another county. That’s why, in the end, the estimation for each combination of county and floor level (i.e. <span class="math notranslate nohighlight">\(\gamma_{jk}\)</span>) is the mean of the measurements in that county and
floor level (plus prior smoothing) as is reflected in the diagonal scatterplot above.</p>
</section>
</section>
</section>
</section>
<section id="Multilevel-and-hierarchical-models">
<h2>Multilevel and hierarchical models<a class="headerlink" href="#Multilevel-and-hierarchical-models" title="Permalink to this heading">#</a></h2>
<p>In this section we are going to explore various types of hierarchical models. If you’re familiar with the PyMC way of using hierarchies, the Bambi way (borrowed from mixed effects models way) may be a bit unfamiliar in the beginning, but as we will see, the notation is very convenient. A good explanation is found in <a class="reference external" href="https://www.bayesrulesbook.com/chapter-16.html">Chapter 16 from Bayes Rules book</a>, specifically <a class="reference external" href="https://www.bayesrulesbook.com/chapter-16.html#another-way-to-think-about-it">section
16.3.2</a>. Moreover, you can also take a look into the <a class="reference external" href="https://bambinos.github.io/bambi/main/examples.html">Bambi examples section</a> where you can find other use cases.</p>
<section id="Partial-pooling-model">
<h3>Partial pooling model<a class="headerlink" href="#Partial-pooling-model" title="Permalink to this heading">#</a></h3>
<p>We start with a model that considers a global intercept and varying intercepts for each county. The dispersion parameter of the prior for these varying intercepts is an <em>hyperprior</em> that is common to all the counties. As we are going to conclude later, this is what causes the <strong>partial pooling</strong> in the model estimates.</p>
<section id="id5">
<h4>Model<a class="headerlink" href="#id5" title="Permalink to this heading">#</a></h4>
<p>Let us use greek letters for common effects and roman letters for varying effects. In this case, <span class="math notranslate nohighlight">\(\alpha\)</span> is a common intercept and <span class="math notranslate nohighlight">\(u\)</span> is a group-specific intercept.</p>
<div class="math notranslate nohighlight">
\[y = \alpha + u_j + \varepsilon\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
y &amp;= \text{Response for the (log) radon measurement } \\
\alpha &amp;= \text{Intercept common to all measurements or global intercept} \\
u_j &amp;= \text{Intercept specific to the county } j \\
\varepsilon &amp; = \text{Residual random error}
\end{aligned}\end{split}\]</div>
</section>
<section id="id6">
<h4>Priors<a class="headerlink" href="#id6" title="Permalink to this heading">#</a></h4>
<section id="id7">
<h5>Common effects<a class="headerlink" href="#id7" title="Permalink to this heading">#</a></h5>
<p>The only common effect in this model is the intercept <span class="math notranslate nohighlight">\(\alpha\)</span>. We have</p>
<div class="math notranslate nohighlight">
\[\alpha \sim \text{Normal}(0, \sigma_\alpha)\]</div>
<p>where <span class="math notranslate nohighlight">\(\sigma_\alpha\)</span> is a positive constant that we set to 10.</p>
</section>
<section id="Group-specific-effects">
<h5>Group-specific effects<a class="headerlink" href="#Group-specific-effects" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[u_j \sim \text{Normal}(0, \sigma_u)\]</div>
<p>for all <span class="math notranslate nohighlight">\(j: 1, \cdots, 85\)</span>.</p>
<p>Contrary to the common effects case, <span class="math notranslate nohighlight">\(\sigma_u\)</span> is considered a random variable.</p>
<p>We assign <span class="math notranslate nohighlight">\(\sigma_u\)</span> the following hyperprior, which is the same to all the counties,</p>
<div class="math notranslate nohighlight">
\[\sigma_u\sim \text{Exponential}(\tau)\]</div>
<p>and <span class="math notranslate nohighlight">\(\tau\)</span> is a positive constant that we set to <span class="math notranslate nohighlight">\(1\)</span>.</p>
</section>
<section id="id8">
<h5>Residual error<a class="headerlink" href="#id8" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\varepsilon &amp; \sim \text{Normal}(0, \sigma) \\
\sigma &amp; \sim \text{Exponential}(\lambda)
\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda\)</span> is a positive constant that we set to 1.</p>
</section>
</section>
<section id="Notes">
<h4>Notes<a class="headerlink" href="#Notes" title="Permalink to this heading">#</a></h4>
<p>The common intercept <span class="math notranslate nohighlight">\(\alpha\)</span> represents the mean response across all counties and floor levels.</p>
<p>On top of it, the county-specific intercept terms <span class="math notranslate nohighlight">\(u_j\)</span> represent county-specific deviations from that global mean. This type of term is also known as a vaying intercept in the statistical literature.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We can add the hyper-priors inside the prior dictionary parameter of the model constructor</span>
<span class="n">partial_pooling_priors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Intercept&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="s2">&quot;1|county&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Exponential&quot;</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
    <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Exponential&quot;</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">partial_pooling_model</span> <span class="o">=</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
    <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;log_radon ~ 1 + (1|county)&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">priors</span><span class="o">=</span><span class="n">partial_pooling_priors</span><span class="p">,</span>
    <span class="n">noncentered</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="n">partial_pooling_model</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Formula: log_radon ~ 1 + (1|county)
Family name: Gaussian
Link: identity
Observations: 919
Priors:
  Common-level effects
    Intercept ~ Normal(mu: 0, sigma: 10)

  Group-level effects
    1|county ~ Normal(mu: 0, sigma: Exponential(lam: 1))

  Auxiliary parameters
    sigma ~ Exponential(lam: 1)
</pre></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">noncentered</span></code> argument asks Bambi not to use the non centered representation for the varying effects. This makes the graph representation clearer and is closer to the original implementation in the PyMC documentation.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">partial_pooling_results</span> <span class="o">=</span> <span class="n">partial_pooling_model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [Intercept, 1|county_sigma, 1|county, log_radon_sigma]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
  <progress value='8000' class='' max='8000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [8000/8000 00:04<00:00 Sampling 4 chains, 0 divergences]
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 5 seconds.
</pre></div></div>
</div>
<p>We can inspect the graphical representation of the model:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">partial_pooling_model</span><span class="o">.</span><span class="n">graph</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_76_0.svg" src="../_images/notebooks_radon_example_76_0.svg" /></div>
</div>
<p>We can clearly see a new hierarchical level as compared to the complete pooling model and unpooled model.</p>
<p>Next, we can plot the posterior distribution of the coefficients in the model:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">partial_pooling_results</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chain_prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Partial Pooling Model Trace&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_79_0.png" src="../_images/notebooks_radon_example_79_0.png" />
</div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">1|county</span></code> is <span class="math notranslate nohighlight">\(u_j\)</span>, the county-specific intercepts.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">1|county_sigma</span></code> is <span class="math notranslate nohighlight">\(\sigma_u\)</span>, the standard deviation of the county-specific intercepts above.</p></li>
</ul>
<p>Let us now compare the posterior predictive mean against the observed data at county level.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">partial_pooling_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">partial_pooling_results</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;pps&quot;</span><span class="p">)</span>

<span class="c1"># Stack chains and draws. pps stands for posterior predictive samples</span>
<span class="n">pps</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract_dataset</span><span class="p">(</span><span class="n">partial_pooling_results</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;posterior_predictive&quot;</span><span class="p">)[</span><span class="s2">&quot;log_radon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">pps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pps</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">county</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;county&quot;</span><span class="p">])</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">pps_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;county&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y_sample</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;county&quot;</span><span class="p">)[</span><span class="s2">&quot;log_radon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">y_sample</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axline</span><span class="p">(</span><span class="n">xy1</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">slope</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;diagonal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y_pred</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predicted global mean&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;log(Radon + 0.1) Mean per County (Partial Pooling Model)&quot;</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;observed (sample)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span>
    <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">2.7</span><span class="p">),</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">2.7</span><span class="p">),</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_82_0.png" src="../_images/notebooks_radon_example_82_0.png" />
</div>
</div>
<p>Note that in this case the points are not concentrated along the diagonal (as it was the case for the unpooled model). The reason is that in the partial pooling model the hyperprior shrinks the predictions towards the global mean, represented by the horizonital dashed line.</p>
<p><strong>What does partial pooling exactly mean here?</strong></p>
<p>We said the first model we built performed a <strong>complete pooling</strong> because estimates pooled observations regardless to which county they belong to. We could see that in the coefficients for the <code class="docutils literal notranslate"><span class="pre">floor</span></code> variable. The estimate for each level was the sample mean for each level, plus prior smoothing, without making any special distinction to observations from different counties.</p>
<p>Then, when we built our second model we said it performed <strong>no pooling</strong>. This was the opposite scenario. Estimates for effects involving a specific county were not informed at all by the information in the other counties.</p>
<p>Now, we say this model performs <strong>partial pooling</strong>. But what does it mean? Well, if we had <strong>complete</strong> pooling and <strong>no</strong> pooling, this must be some type of compromise in between.</p>
<p>In this model, we have a global intercept <span class="math notranslate nohighlight">\(\alpha\)</span>, which represents the mean of the response variable across all counties. We also have group-specific intercepts <span class="math notranslate nohighlight">\(u_j\)</span> that represent deviations from the global mean specific to each county <span class="math notranslate nohighlight">\(j\)</span>. Thess group-specific intercepts are assigned a Normal prior centered at 0. The standard deviations of these priors are considered random, instead of fixed. Since they are random, they are assigned a prior distribution, which is a
hyperprior in this case because it is a prior on top of a prior. And that hyperprior is the same distribution for all the county-specific intercepts. Because of that, these random deviations from the global mean are not independent. Indeed, the shared hyperprior is what causes the <strong>partial pooling</strong> in the model estimates. In other words, some information is shared between counties when computing estimates for their effects and it results in a shrinkage towards the global mean.</p>
<p>Connecting what we’ve just said with the figure above we can see the <strong>partial pooling is a compromise between complete pooling (global mean) and no pooling (diagonal)</strong>.</p>
</section>
</section>
<section id="County-specific-intercepts-and-common-predictors">
<h3>County-specific intercepts and common predictors<a class="headerlink" href="#County-specific-intercepts-and-common-predictors" title="Permalink to this heading">#</a></h3>
<p>Next, we add the <code class="docutils literal notranslate"><span class="pre">floor</span></code> global feature (i.e. does not depend on the <code class="docutils literal notranslate"><span class="pre">county</span></code>) into the model above. We remove the global intercept so Bambi keeps one coefficient for each <code class="docutils literal notranslate"><span class="pre">floor</span></code> level.</p>
<p>In the original PyMC example, this model is introduced under the <a class="reference external" href="https://docs.pymc.io/projects/examples/en/latest/case_studies/multilevel_modeling.html#varying-intercept-model">Varying intercept model</a> title. We feel that “County-specific intercepts and common predictors” is a more accurate representation of the model we build in Bambi. It is correct to say this is a varying intercept model, because of the county-specific intercepts, but so was the last model we built.</p>
<section id="id9">
<h4>Model<a class="headerlink" href="#id9" title="Permalink to this heading">#</a></h4>
<div class="math notranslate nohighlight">
\[y = \beta_j + u_k + \varepsilon\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
y &amp;= \text{Response for the (log) radon measurement } \\
\beta_j &amp;= \text{Coefficient for the floor level } j \\
u_k &amp;= \text{Intercept specific to the county } k \\
\varepsilon &amp; = \text{Residual random error}
\end{aligned}\end{split}\]</div>
</section>
<section id="id10">
<h4>Priors<a class="headerlink" href="#id10" title="Permalink to this heading">#</a></h4>
<section id="id11">
<h5>Common effects<a class="headerlink" href="#id11" title="Permalink to this heading">#</a></h5>
<p>The common effect in this model is the floor term <span class="math notranslate nohighlight">\(\beta_j\)</span></p>
<div class="math notranslate nohighlight">
\[\beta_j \sim \text{Normal}(0, \sigma_{\beta_j})\]</div>
<p>for all <span class="math notranslate nohighlight">\(j: 1, 2\)</span> and <span class="math notranslate nohighlight">\(\sigma_{\beta_j}\)</span> is a positive constant that we set to <span class="math notranslate nohighlight">\(10\)</span>.</p>
</section>
<section id="id12">
<h5>Group-specific effects<a class="headerlink" href="#id12" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[u_k \sim \text{Normal}(0, \sigma_u)\]</div>
<p>for all <span class="math notranslate nohighlight">\(j:1, \cdots, 85\)</span>. The hyperprior is</p>
<p>$$</p>
<p><span class="math">\sigma</span>_u <span class="math">\sim `:nbsphinx-math:</span>text{Exponential}`(<span class="math">\tau</span>)</p>
<p>$$</p>
<p>and <span class="math notranslate nohighlight">\(\tau\)</span> is a positive constant that we set to <span class="math notranslate nohighlight">\(1\)</span>.</p>
</section>
<section id="id13">
<h5>Residual error<a class="headerlink" href="#id13" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\varepsilon &amp; \sim \text{Normal}(0, \sigma) \\
\sigma &amp; \sim \text{Exponential}(\lambda)
\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda\)</span> is a positive constant that we set to <span class="math notranslate nohighlight">\(1\)</span>.</p>
</section>
<section id="id14">
<h5>Notes<a class="headerlink" href="#id14" title="Permalink to this heading">#</a></h5>
<p><span class="math notranslate nohighlight">\(\beta_j\)</span> and <span class="math notranslate nohighlight">\(u_k\)</span> may look similar. The difference is that the latter is a hierarchical effect (it has a hyperprior), while the former is not.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">varying_intercept_priors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;floor&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="s2">&quot;1|county&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Exponential&quot;</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
    <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Exponential&quot;</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">varying_intercept_model</span> <span class="o">=</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
    <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;log_radon ~ 0 + floor + (1|county)&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">priors</span><span class="o">=</span><span class="n">varying_intercept_priors</span><span class="p">,</span>
    <span class="n">noncentered</span><span class="o">=</span><span class="kc">False</span>
 <span class="p">)</span>

<span class="n">varying_intercept_model</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Formula: log_radon ~ 0 + floor + (1|county)
Family name: Gaussian
Link: identity
Observations: 919
Priors:
  Common-level effects
    floor ~ Normal(mu: 0, sigma: 10)

  Group-level effects
    1|county ~ Normal(mu: 0, sigma: Exponential(lam: 1))

  Auxiliary parameters
    sigma ~ Exponential(lam: 1)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">varying_intercept_results</span> <span class="o">=</span> <span class="n">varying_intercept_model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [floor, 1|county_sigma, 1|county, log_radon_sigma]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
  <progress value='8000' class='' max='8000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [8000/8000 00:22<00:00 Sampling 4 chains, 0 divergences]
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 23 seconds.
</pre></div></div>
</div>
<p>When looking at the graph representation of the model we still see the hierarchical structure for the <code class="docutils literal notranslate"><span class="pre">county</span></code> varying intercepts, but we do not see it for the <code class="docutils literal notranslate"><span class="pre">floor</span></code> feature as expected.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">varying_intercept_model</span><span class="o">.</span><span class="n">graph</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_92_0.svg" src="../_images/notebooks_radon_example_92_0.svg" /></div>
</div>
<p>Let us visualize the posterior distributions:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">varying_intercept_results</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chain_prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">});</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Varying Intercepts Model Trace&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_94_0.png" src="../_images/notebooks_radon_example_94_0.png" />
</div>
</div>
</section>
</section>
</section>
<section id="Varying-intercept-and-slope-model">
<h3>Varying intercept and slope model<a class="headerlink" href="#Varying-intercept-and-slope-model" title="Permalink to this heading">#</a></h3>
<p>Next we want to include a hierarchical structure in the floor effect.</p>
<section id="id15">
<h4>Model<a class="headerlink" href="#id15" title="Permalink to this heading">#</a></h4>
<div class="math notranslate nohighlight">
\[y = \beta_j + b_{jk} + \varepsilon\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
y &amp;= \text{Response for the (log) radon measurement}\\
\beta_j &amp;= \text{Coefficient for the floor level } j \\
b_{jk} &amp;= \text{Coefficient for the floor level } j \text{ specific to the county } k\\
\varepsilon &amp; = \text{Residual random error}
\end{aligned}\end{split}\]</div>
</section>
<section id="id16">
<h4>Priors<a class="headerlink" href="#id16" title="Permalink to this heading">#</a></h4>
<section id="id17">
<h5>Common effects<a class="headerlink" href="#id17" title="Permalink to this heading">#</a></h5>
<p>The common effect in this model is the floor term <span class="math notranslate nohighlight">\(\beta_j\)</span></p>
<div class="math notranslate nohighlight">
\[\beta_j \sim \text{Normal}(0, \sigma_{\beta_j})\]</div>
<p>where <span class="math notranslate nohighlight">\(\sigma_{\beta_j}\)</span> is a positive constant that we set to <span class="math notranslate nohighlight">\(10\)</span>.</p>
</section>
<section id="id18">
<h5>Group-specific effects<a class="headerlink" href="#id18" title="Permalink to this heading">#</a></h5>
<p>Here, again, we have the floor effects</p>
<div class="math notranslate nohighlight">
\[b_{jk} \sim \text{Normal}(0, \sigma_{b_j})\]</div>
<p>for <span class="math notranslate nohighlight">\(j:1, 2\)</span> and <span class="math notranslate nohighlight">\(k: 1, \cdots, 85\)</span>.</p>
<p>The hyperprior is</p>
<div class="math notranslate nohighlight">
\[\sigma_{b_j} \sim \text{Exponential}(\tau)\]</div>
<p>for <span class="math notranslate nohighlight">\(j:1, 2\)</span>.</p>
<p><span class="math notranslate nohighlight">\(\tau\)</span> is a positive constant that we set to <span class="math notranslate nohighlight">\(1\)</span>.</p>
</section>
<section id="id19">
<h5>Residual error<a class="headerlink" href="#id19" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\varepsilon &amp; \sim \text{Normal}(0, \sigma) \\
\sigma &amp; \sim \text{Exponential}(\lambda)
\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda\)</span> is a positive constant that we set to 1.</p>
</section>
<section id="id20">
<h5>Notes<a class="headerlink" href="#id20" title="Permalink to this heading">#</a></h5>
<p>Both <span class="math notranslate nohighlight">\(\beta_j\)</span> and <span class="math notranslate nohighlight">\(b_{jk}\)</span> are floor effects. The difference is that the first one is a common effect, while the second is a group-specific effect. In other words, the second floor effect varies from county to county. These effects represent the county specific deviations from the common floor effect <span class="math notranslate nohighlight">\(\beta_j\)</span>. Because of the hyperprior, the <span class="math notranslate nohighlight">\(b_{jk}\)</span> effects aren’t independent and result in the partial-pooling effect.</p>
<p>In this case the Bambi model specification is quite easy, namely <code class="docutils literal notranslate"><span class="pre">log_radon</span> <span class="pre">~</span> <span class="pre">0</span> <span class="pre">+</span> <span class="pre">floor</span> <span class="pre">+</span> <span class="pre">(0</span> <span class="pre">+</span> <span class="pre">floor|county)</span></code>. This formula represents the following terms:</p>
<ul class="simple">
<li><p>The first <code class="docutils literal notranslate"><span class="pre">0</span></code> tells we don’t want a global intercept.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">floor</span></code> is <span class="math notranslate nohighlight">\(\beta_j\)</span>. It says we want to include an effect for each floor level. Since there’s no global intercept, a coefficient for each level is included.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">0</span></code> in <code class="docutils literal notranslate"><span class="pre">(0</span> <span class="pre">+</span> <span class="pre">floor|county)</span></code> means we don’t want county-specific intercept. We need to explicitly turn it off as we did with the regular intercept.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">floor|county</span></code> is <span class="math notranslate nohighlight">\(b_{jk}\)</span>, the county-specific floor coefficients. Again, since there’s no varying intercepot for the counties, this includes coefficients for both floor levels.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">varying_intercept_slope_priors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;floor&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="s2">&quot;floor|county&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Exponential&quot;</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
    <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Exponential&quot;</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">varying_intercept_slope_model</span> <span class="o">=</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
    <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;log_radon ~ 0 + floor + (0 + floor|county)&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">priors</span><span class="o">=</span><span class="n">varying_intercept_slope_priors</span><span class="p">,</span>
    <span class="n">noncentered</span><span class="o">=</span><span class="kc">True</span>
 <span class="p">)</span>

<span class="n">varying_intercept_slope_model</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Formula: log_radon ~ 0 + floor + (0 + floor|county)
Family name: Gaussian
Link: identity
Observations: 919
Priors:
  Common-level effects
    floor ~ Normal(mu: 0, sigma: 10)

  Group-level effects
    floor|county ~ Normal(mu: 0, sigma: Exponential(lam: 1))

  Auxiliary parameters
    sigma ~ Exponential(lam: 1)
</pre></div></div>
</div>
<p>Next, we fit the model. Note we increase the default number of <code class="docutils literal notranslate"><span class="pre">draws</span></code> from the posterior and the <code class="docutils literal notranslate"><span class="pre">tune</span></code> samples to 2000. In addition, as the structure of the model gets more complex, so does the posterior. That’s why we increase <code class="docutils literal notranslate"><span class="pre">target_accept</span></code> from the default 0.8 to 0.9, because we want to explore the posterior more cautiously .</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">varying_intercept_slope_results</span> <span class="o">=</span> <span class="n">varying_intercept_slope_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">draws</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
    <span class="n">tune</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
    <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.9</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [floor, floor|county_sigma, floor|county_offset, log_radon_sigma]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
  <progress value='16000' class='' max='16000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [16000/16000 01:41<00:00 Sampling 4 chains, 0 divergences]
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sampling 4 chains for 2_000 tune and 2_000 draw iterations (8_000 + 8_000 draws total) took 101 seconds.
</pre></div></div>
</div>
<p>In the graph representation of the model we can now see hierarchical structures both in the intercepts and the slopes. The terms that end with <code class="docutils literal notranslate"><span class="pre">_offset</span></code> appeared because we are using a non-centered parametrization. This parametrization is an algebraic trick that helps computation but leaves the model unchanged.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">varying_intercept_slope_model</span><span class="o">.</span><span class="n">graph</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_105_0.svg" src="../_images/notebooks_radon_example_105_0.svg" /></div>
</div>
<p>Let’s have a look at the marginal posterior for the coefficients in the model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">var_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;floor&quot;</span><span class="p">,</span> <span class="s2">&quot;floor|county&quot;</span><span class="p">,</span> <span class="s2">&quot;floor|county_sigma&quot;</span><span class="p">,</span> <span class="s2">&quot;log_radon_sigma&quot;</span><span class="p">]</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">varying_intercept_slope_results</span><span class="p">,</span>
    <span class="n">var_names</span><span class="o">=</span><span class="n">var_names</span><span class="p">,</span>
    <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">chain_prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_107_0.png" src="../_images/notebooks_radon_example_107_0.png" />
</div>
</div>
</section>
</section>
</section>
<section id="Adding-group-level-predictors">
<h3>Adding group-level predictors<a class="headerlink" href="#Adding-group-level-predictors" title="Permalink to this heading">#</a></h3>
<p>We now want to consider a county-level predictor, namely the (log) uranium level. This is not a county-level predictor in the sense that we use a county-specific coefficient, but in the sense that all the uranium concentrations were measured per county. Thus all the houses in the same county have the same uranium level.</p>
<section id="id21">
<h4>Model<a class="headerlink" href="#id21" title="Permalink to this heading">#</a></h4>
<div class="math notranslate nohighlight">
\[y = \beta_j + \xi x + b_{jk} + \varepsilon\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
y &amp;= \text{Response for the (log) radon measurement} \\
x &amp;= \text{Log uranium concentration} \\
\beta_j &amp;= \text{Coefficient for the floor level } j \\
\xi &amp;= \text{Coefficient for the slope of the log uranium concentration}\\
b_{jk} &amp;= \text{Coefficient for the floor level } j \text{ specific to the county } k\\
\varepsilon &amp; = \text{Residual random error}
\end{aligned}\end{split}\]</div>
</section>
<section id="id22">
<h4>Priors<a class="headerlink" href="#id22" title="Permalink to this heading">#</a></h4>
<section id="id23">
<h5>Common effects<a class="headerlink" href="#id23" title="Permalink to this heading">#</a></h5>
<p>This model has two common effects:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\beta_j \sim \text{Normal}(0, \sigma_{\beta_j}) \\
\xi \sim \text{Normal}(0, \sigma_\xi)
\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(j:1, 2\)</span> and all <span class="math notranslate nohighlight">\(\sigma_{\beta_j}\)</span> and <span class="math notranslate nohighlight">\(\sigma_{\xi}\)</span> are set to <span class="math notranslate nohighlight">\(10\)</span>.</p>
</section>
<section id="id24">
<h5>Group-specific effects<a class="headerlink" href="#id24" title="Permalink to this heading">#</a></h5>
<p>Here, again, we have the floor effects</p>
<div class="math notranslate nohighlight">
\[b_{jk} \sim \text{Normal}(0, \sigma_{b_j})\]</div>
<p>for <span class="math notranslate nohighlight">\(j:1, 2\)</span> and <span class="math notranslate nohighlight">\(k: 1, \cdots, 85\)</span>.</p>
<p>The hyperprior is</p>
<div class="math notranslate nohighlight">
\[\sigma_{b_j} \sim \text{Exponential}(\tau)\]</div>
<p>for <span class="math notranslate nohighlight">\(j:1, 2\)</span>.</p>
<p><span class="math notranslate nohighlight">\(\tau\)</span> is a positive constant that we set to <span class="math notranslate nohighlight">\(1\)</span>.</p>
</section>
<section id="id25">
<h5>Residual error<a class="headerlink" href="#id25" title="Permalink to this heading">#</a></h5>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\varepsilon &amp; \sim \text{Normal}(0, \sigma) \\
\sigma &amp; \sim \text{Exponential}(\lambda)
\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda\)</span> is a positive constant that we set to <span class="math notranslate nohighlight">\(1\)</span>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">covariate_priors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;floor&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="s2">&quot;log_u&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="s2">&quot;floor|county&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Exponential&quot;</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
    <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Prior</span><span class="p">(</span><span class="s2">&quot;Exponential&quot;</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">covariate_model</span> <span class="o">=</span> <span class="n">bmb</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
    <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;log_radon ~ 0 + floor + log_u + (0 + floor|county)&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">priors</span><span class="o">=</span><span class="n">covariate_priors</span><span class="p">,</span>
    <span class="n">noncentered</span><span class="o">=</span><span class="kc">True</span>
 <span class="p">)</span>

<span class="n">covariate_model</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Formula: log_radon ~ 0 + floor + log_u + (0 + floor|county)
Family name: Gaussian
Link: identity
Observations: 919
Priors:
  Common-level effects
    floor ~ Normal(mu: 0, sigma: 10)
    log_u ~ Normal(mu: 0, sigma: 10)

  Group-level effects
    floor|county ~ Normal(mu: 0, sigma: Exponential(lam: 1))

  Auxiliary parameters
    sigma ~ Exponential(lam: 1)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">covariate_results</span> <span class="o">=</span> <span class="n">covariate_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">draws</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
    <span class="n">tune</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
    <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.9</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [floor, log_u, floor|county_sigma, floor|county_offset, log_radon_sigma]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
  <progress value='16000' class='' max='16000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [16000/16000 01:39<00:00 Sampling 4 chains, 2 divergences]
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Sampling 4 chains for 2_000 tune and 2_000 draw iterations (8_000 + 8_000 draws total) took 100 seconds.
There were 2 divergences after tuning. Increase `target_accept` or reparameterize.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">covariate_model</span><span class="o">.</span><span class="n">graph</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_114_0.svg" src="../_images/notebooks_radon_example_114_0.svg" /></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">var_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;floor&quot;</span><span class="p">,</span> <span class="s2">&quot;log_u&quot;</span><span class="p">,</span> <span class="s2">&quot;floor|county&quot;</span><span class="p">,</span> <span class="s2">&quot;floor|county_sigma&quot;</span><span class="p">,</span> <span class="s2">&quot;log_radon_sigma&quot;</span><span class="p">]</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">covariate_results</span><span class="p">,</span>
    <span class="n">var_names</span><span class="o">=</span><span class="n">var_names</span><span class="p">,</span>
    <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">chain_prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_115_0.png" src="../_images/notebooks_radon_example_115_0.png" />
</div>
</div>
<p>Let us now visualize the posterior distributions of the intercepts:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get log_u values per county</span>
<span class="n">log_u_sample</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;county&quot;</span><span class="p">])[</span><span class="s2">&quot;log_u&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># compute the slope posterior samples</span>
<span class="n">log_u_slope</span> <span class="o">=</span> <span class="n">covariate_results</span><span class="o">.</span><span class="n">posterior</span><span class="p">[</span><span class="s2">&quot;log_u&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">log_u_sample</span>

<span class="c1"># Compute the posterior for the floor coefficient when it is Basement</span>
<span class="n">intercepts</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">covariate_results</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">floor_dim</span><span class="o">=</span><span class="s2">&quot;Basement&quot;</span><span class="p">)[</span><span class="s2">&quot;floor&quot;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">covariate_results</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">floor__expr_dim</span><span class="o">=</span><span class="s2">&quot;Basement&quot;</span><span class="p">)[</span><span class="s2">&quot;floor|county&quot;</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">values</span>

<span class="n">y_predicted</span> <span class="o">=</span> <span class="p">(</span><span class="n">intercepts</span> <span class="o">+</span> <span class="n">log_u_slope</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="n">n_counties</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># reduce the intercepts posterior samples to the mean per county</span>
<span class="n">mean_intercept</span> <span class="o">=</span> <span class="n">intercepts</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">log_u_slope</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">y_predicted_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">y_predicted</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">[</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">log_u_sample</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y_predicted</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean county-intercept&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">log_u_sample</span><span class="p">,</span> <span class="n">y_predicted_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_predicted_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_hdi</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">log_u_sample</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">mean_intercept</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">fill_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Mean intercept HPD&quot;</span><span class="p">},</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
<span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">log_u_sample</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">mean_intercept</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8000</span><span class="p">,</span> <span class="n">n_counties</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean intercept&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;County Intercepts (Covariance Model)&quot;</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;County-level log uranium&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Intercept estimate&quot;</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_118_0.png" src="../_images/notebooks_radon_example_118_0.png" />
</div>
</div>
</section>
</section>
</section>
</section>
<hr class="docutils" />
<section id="Summary">
<h2>Summary<a class="headerlink" href="#Summary" title="Permalink to this heading">#</a></h2>
<p>Let us dig deeper into the model comparison for the pooled, unpooled, and partial pooling models. To do so we are generate predictions for each model ad county level, where we aggregate by taking the mean, and plot them against the observed values.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate posterior predictive samples</span>
<span class="n">pooled_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pooled_results</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;pps&quot;</span><span class="p">)</span>
<span class="n">unpooled_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">unpooled_results</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;pps&quot;</span><span class="p">)</span>
<span class="n">partial_pooling_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">partial_pooling_results</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;pps&quot;</span><span class="p">)</span>

<span class="c1"># stack chain and draw values</span>
<span class="n">pooled_pps</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract_dataset</span><span class="p">(</span><span class="n">pooled_results</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;posterior_predictive&quot;</span><span class="p">)[</span><span class="s2">&quot;log_radon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">unpooled_pps</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract_dataset</span><span class="p">(</span><span class="n">unpooled_results</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;posterior_predictive&quot;</span><span class="p">)[</span><span class="s2">&quot;log_radon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">partial_pooling_pps</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract_dataset</span><span class="p">(</span><span class="n">partial_pooling_results</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;posterior_predictive&quot;</span><span class="p">)[</span><span class="s2">&quot;log_radon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Generate predictions per county</span>
<span class="n">pooled_pps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pooled_pps</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">county</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;county&quot;</span><span class="p">])</span>
<span class="n">y_pred_pooled</span> <span class="o">=</span> <span class="n">pooled_pps_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;county&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">unpooled_pps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">unpooled_pps</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">county</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;county&quot;</span><span class="p">])</span>
<span class="n">y_pred_unpooled</span> <span class="o">=</span> <span class="n">unpooled_pps_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;county&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">partial_pooling_pps_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">partial_pooling_pps</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">county</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;county&quot;</span><span class="p">])</span>
<span class="n">y_pred_partial_pooling</span> <span class="o">=</span> <span class="n">partial_pooling_pps_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;county&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># observed values</span>
<span class="n">y_sample</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;county&quot;</span><span class="p">)[</span><span class="s2">&quot;log_radon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">y_sample</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_pred_pooled</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pooled&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">y_sample</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_pred_unpooled</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;unpooled&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">y_sample</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_pred_partial_pooling</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;partial pooling&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;log_radon&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;sample mean&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axline</span><span class="p">(</span><span class="n">xy1</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">slope</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;diagonal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y_pred_partial_pooling</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C3&quot;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;predicted global mean (partial pooling)&quot;</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper center&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;log(Radon + 0.1) Mean per County - Model Comparison&quot;</span><span class="p">,</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;observed (sample)&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span>
    <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">),</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">),</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_radon_example_122_0.png" src="../_images/notebooks_radon_example_122_0.png" />
</div>
</div>
<ul class="simple">
<li><p>The pooled model consider all the counties together, this explains why the predictions do not vary at county level. This is represented by the almost-flat line in the plot above (blue).</p></li>
<li><p>On the other hand, the unpooled model considers each county separately, so the prediction is very close to the observation mean. This is represented by the line very close to the diagonal (orange).</p></li>
<li><p>The partial pooling model is mixing global and information at county level. This is clearly seen by how corresponding (green) line is in between the pooling and unpooling lines.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> watermark
<span class="o">%</span><span class="k">watermark</span> -n -u -v -iv -w
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Last updated: Thu Jun 16 2022

Python implementation: CPython
Python version       : 3.9.7
IPython version      : 8.3.0

matplotlib: 3.5.1
sys       : 3.9.7 (default, Sep 16 2021, 13:09:58)
[GCC 7.5.0]
numpy     : 1.21.5
pandas    : 1.4.2
bambi     : 0.9.0
arviz     : 0.13.0.dev0
pymc      : 4.0.0
seaborn   : 0.11.2

Watermark: 2.3.0

</pre></div></div>
</div>
</section>
</section>


            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="sleepstudy.html" title="previous page">
      <i class="fas fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Hierarchical Linear Regression (Sleepstudy example)</p>
      </div>
  </a>
  <a class='right-next' id="next-link" href="Strack_RRR_re_analysis.html" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">Bayesian Workflow (Strack RRR Analysis Replication)</p>
  </div>
  <i class="fas fa-angle-right"></i>
  </a>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div class="tocsection onthispage">
    <i class="fas fa-list"></i> On this page
</div>
<nav id="bd-toc-nav" class="page-toc">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Prepare-Notebook">
   Prepare Notebook
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Read-Data">
   Read Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Preprocess-Data">
   Preprocess Data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#EDA">
   EDA
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Models:-Conventional-Approaches">
   Models: Conventional Approaches
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Complete-Pooling">
     Complete Pooling
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#Model">
       Model
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#Priors">
       Priors
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#Common-effects">
         Common effects
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#Residual-error">
         Residual error
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#No-Pooling">
     No Pooling
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Model
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Priors
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id3">
         Common effects
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id4">
         Residual error
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Multilevel-and-hierarchical-models">
   Multilevel and hierarchical models
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Partial-pooling-model">
     Partial pooling model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id5">
       Model
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id6">
       Priors
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id7">
         Common effects
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#Group-specific-effects">
         Group-specific effects
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id8">
         Residual error
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#Notes">
       Notes
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#County-specific-intercepts-and-common-predictors">
     County-specific intercepts and common predictors
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id9">
       Model
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id10">
       Priors
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id11">
         Common effects
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id12">
         Group-specific effects
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id13">
         Residual error
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id14">
         Notes
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Varying-intercept-and-slope-model">
     Varying intercept and slope model
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id15">
       Model
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id16">
       Priors
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id17">
         Common effects
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id18">
         Group-specific effects
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id19">
         Residual error
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id20">
         Notes
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Adding-group-level-predictors">
     Adding group-level predictors
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id21">
       Model
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id22">
       Priors
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id23">
         Common effects
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id24">
         Group-specific effects
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id25">
         Residual error
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Summary">
   Summary
  </a>
 </li>
</ul>

</nav>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
<div class="tocsection sourcelink">
    <a href="../_sources/notebooks/radon_example.ipynb.txt">
        <i class="fas fa-file-alt"></i> Show Source
    </a>
</div>

</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=9b1a4fa89bdd0e95b23b"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2022, The developers of Bambi.<br>

</p>

  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.1.1.<br>
</p>

  </div>
  
</div>
  </footer>
  </body>
</html>